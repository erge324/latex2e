\makeatletter





% quoting spaces
% a b c     -> "a b c"
% "a b c"   -> "a b c"
% a" "b" "c -> "a b c"
%           -> ""
\def\quote@name#1{"\quote@@name#1\@gobble""}
\def\quote@@name#1"{#1\quote@@name}


% utf8

\long\def\UTFviii@two@octets{%
  \ifx\protect\relax
    \ifincsname
      \expandafter\expandafter\expandafter
      \UTF@twoharmless@octets
    \fi
  \else
    \expandafter\UTF@twoharmless@octets
  \fi
  \UTFviii@two@octets@do
}


\long\def\UTFviii@three@octets{%
  \ifx\protect\relax
    \ifincsname
      \expandafter\expandafter\expandafter
      \UTF@threeharmless@octets
    \fi
  \else
    \expandafter\UTF@threeharmless@octets
  \fi
  \UTFviii@three@octets@do
}


\long\def\UTFviii@four@octets{%
  \ifx\protect\relax
    \ifincsname
      \expandafter\expandafter\expandafter
      \UTF@fourharmless@octets
    \fi
  \else
    \expandafter\UTF@fourharmless@octets
  \fi
  \UTFviii@four@octets@do
}



\long\def\UTFviii@two@octets@do#1#2{\expandafter
    \UTFviii@defined\csname u8:#1\string#2\endcsname}
\long\def\UTFviii@three@octets@do#1#2#3{\expandafter
    \UTFviii@defined\csname u8:#1\string#2\string#3\endcsname}
\long\def\UTFviii@four@octets@do#1#2#3#4{\expandafter
    \UTFviii@defined\csname u8:#1\string#2\string#3\string#4\endcsname}


\long\def\UTF@twoharmless@octets#1#2{\string#2\string}
\long\def\UTF@threeharmless@octets#1#2#3{\string#2\string#3\string}
\long\def\UTF@fourharmless@octets#1#2#3#4{\string#2\string#3\string#4\string}


% the next one isn't quite safe as \@curr@file bight get changed by
% another test (see 25 year old bug fixed this morning, but that can
% be mended

\long\def \IfFileExists#1#2#3{%
  \set@curr@file{#1}%
  \edef\q@curr@file{\expandafter\quote@name\expandafter{\@curr@file}}%
  \openin\@inputcheck\q@curr@file\space
  \ifeof\@inputcheck
    \ifx\input@path\@undefined
      \def\reserved@a{#3}%
    \else
      \def\reserved@a{\@iffileonpath\q@curr@file{#2}{#3}}%
    \fi
  \else
    \closein\@inputcheck
    \edef\@filef@und{\q@curr@file\space }%
    \def\reserved@a{#2}%
  \fi
  \reserved@a}

\long\def \InputIfFileExists#1#2{%
  \IfFileExists{#1}%
    {#2\@addtofilelist{#1}\@@input \@filef@und}}

\def\set@curr@file#1{%
  \begingroup
    \escapechar\m@ne
    \xdef\@curr@file{\expandafter\string\csname #1\endcsname}%
  \endgroup
}

\def\@iinput#1{%
  \InputIfFileExists{#1}{}%
  {\filename@parse\@curr@file
   \edef\reserved@a{\noexpand\@missingfileerror
     {\filename@area\filename@base}%
     {\ifx\filename@ext\relax tex\else\filename@ext\fi}}%
   \reserved@a}}


\def\@include#1 {%
  \clearpage
  \set@curr@file{#1}%
  \if@filesw
    \immediate\write\@mainaux{\string\@input{\@curr@file.aux}}%
  \fi
  \@tempswatrue
  \if@partsw
    \@tempswafalse
    \@for\reserved@a:=\@partlist\do
      {\ifx\reserved@a\@curr@file\@tempswatrue\fi}%
  \fi
  \if@tempswa
    \let\@auxout\@partaux
    \if@filesw
      \immediate\openout\@partaux \@curr@file.aux
      \immediate\write\@partaux{\relax}%
    \fi
    \@input@{\@curr@file.tex}%
    \clearpage
    \@writeckpt{\@curr@file}%
    \if@filesw
      \immediate\closeout\@partaux
    \fi
  \else
    \deadcycles\z@
    \@nameuse{cp@\@curr@file}%
  \fi
  \let\@auxout\@mainaux}

% that zapspace ... hmmm

\def\includeonly#1{%
  \@partswtrue
  \set@curr@file{\zap@space#1 \@empty}%
  \let\@partlist\@curr@file
  }


\begingroup%
\@tempcnta=1
\loop
  \catcode\@tempcnta=12  %
  \advance\@tempcnta\@ne %
\ifnum\@tempcnta<32      %
\repeat                  %
\catcode`\*=11 %
\catcode`\^^M\active%
\catcode`\^^L\active\let^^L\relax%
\catcode`\^^I\active%
\gdef\filec@ntents#1{%
  \set@curr@file{#1}%
  \edef\q@curr@file{\expandafter\quote@name\expandafter{\@curr@file}}%
  \openin\@inputcheck\q@curr@file \space %
  \ifeof\@inputcheck%
    \@latex@warning@no@line%
        {Writing file `\@currdir\@curr@file'}%
    \chardef\reserved@c15 %
    \ch@ck7\reserved@c\write%
    \immediate\openout\reserved@c\q@curr@file\relax%
  \else%
    \closein\@inputcheck%
    \@latex@warning@no@line%
            {File `\@curr@file' already exists on the system.\MessageBreak%
             Not generating it from this source}%
    \let\write\@gobbletwo%
    \let\closeout\@gobble%
  \fi%
  \if@tempswa%
    \immediate\write\reserved@c{%
      \@percentchar\@percentchar\space%
          \expandafter\@gobble\string\LaTeX2e file `\@curr@file'^^J%
      \@percentchar\@percentchar\space  generated by the %
        `\@currenvir' \expandafter\@gobblefour\string\newenvironment^^J%
      \@percentchar\@percentchar\space from source `\jobname' on %
         \number\year/\two@digits\month/\two@digits\day.^^J%
      \@percentchar\@percentchar}%
  \fi%
  \let\do\@makeother\dospecials%
  \count@ 128\relax%
  \loop%
    \catcode\count@ 11\relax%
    \advance\count@ \@ne%
    \ifnum\count@<\@cclvi%
  \repeat%
  \edef\E{\@backslashchar end\string{\@currenvir\string}}%
  \edef\reserved@b{%
    \def\noexpand\reserved@b%
         ####1\E####2\E####3\relax}%
  \reserved@b{%
    \ifx\relax##3\relax%
      \immediate\write\reserved@c{##1}%
    \else%
      \edef^^M{\noexpand\end{\@currenvir}}%
      \ifx\relax##1\relax%
      \else%
          \@latex@warning{Writing text `##1' before %
             \string\end{\@currenvir}\MessageBreak as last line of \@curr@file}%
        \immediate\write\reserved@c{##1}%
      \fi%
      \ifx\relax##2\relax%
      \else%
         \@latex@warning{%
           Ignoring text `##2' after \string\end{\@currenvir}}%
      \fi%
    \fi%
    ^^M}%
  \catcode`\^^L\active%
  \let\L\@undefined%
  \def^^L{\expandafter\ifx\csname L\endcsname\relax\fi ^^J^^J}%
  \catcode`\^^I\active%
  \let\I\@undefined%
  \def^^I{\expandafter\ifx\csname I\endcsname\relax\fi\space}%
  \catcode`\^^M\active%
  \edef^^M##1^^M{%
    \noexpand\reserved@b##1\E\E\relax}}%
\endgroup%




% graphics

\def\unquote@name#1{\quote@@name#1\@gobble"}


\AtBeginDocument{%
\def\Gin@getbase#1{%
  \edef\Gin@tempa{%
    \def\noexpand\@tempa####1#1\space{%
      \def\noexpand\Gin@base{"####1"}}}%
  \IfFileExists{\filename@area\filename@base#1}%
    {\Gin@tempa
\edef\uq@filef@und{\expandafter\unquote@name\expandafter{\@filef@und}}%
     \expandafter\@tempa\uq@filef@und
     \edef\Gin@ext{#1}}{}}%

\def\Ginclude@graphics#1{%
  \edef\Gin@extensions{\detokenize\expandafter{\Gin@extensions}}%
  \begingroup
  \let\input@path\Ginput@path
  \set@curr@file{#1}%
  \edef\uq@curr@file{\expandafter\unquote@name\expandafter{\@curr@file}}%
  \expandafter\filename@parse\expandafter{\uq@curr@file}%
  \edef\filename@area{\expandafter\quote@name\expandafter{\filename@area}}%
  \edef\filename@base{\expandafter\quote@name\expandafter{\filename@base}}%
  \ifx\filename@ext\relax
    \@for\Gin@temp:=\Gin@extensions\do{%
      \ifx\Gin@ext\relax
        \Gin@getbase\Gin@temp
      \fi}%
  \else
    \Gin@getbase{\Gin@sepdefault\filename@ext}%
    \ifx\Gin@ext\relax
       \@warning{File `#1' not found}%
       \def\Gin@base{\filename@area\filename@base}%
       \edef\Gin@ext{\Gin@sepdefault\filename@ext}%
    \fi
  \fi
    \ifx\Gin@ext\relax
         \@latex@error{File `#1' not found}%
         {I could not locate the file with any of these extensions:^^J%
          \Gin@extensions^^J\@ehc}%
    \else
       \@ifundefined{Gin@rule@\Gin@ext}%
         {\ifx\Gin@rule@*\@undefined
            \@latex@error{Unknown graphics extension: \Gin@ext}\@ehc
          \else
            \expandafter\Gin@setfile\Gin@rule@*{\Gin@base\Gin@ext}%
           \fi}%
         {\expandafter\expandafter\expandafter\Gin@setfile
             \csname Gin@rule@\Gin@ext\endcsname{\Gin@base\Gin@ext}}%
    \fi
  \endgroup}
}
\makeatother


